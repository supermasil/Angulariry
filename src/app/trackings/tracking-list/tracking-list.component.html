
<form [formGroup]='trackingForm' (submit)='onFuzzySearch()'>
  <div class="d-flex">
    <a
      mat-mini-fab
      color='primary'
      class="mt-2 d-inline mr-2"
      onclick="document.getElementById('cameraButton').click()">
      <mat-icon>photo_camera</mat-icon>
    </a>
    <mat-form-field appearance="outline">
      <mat-label>Search here</mat-label>
      <input
        matInput
        type='text'
        formControlName='searchTerm'>
    </mat-form-field>
    <button
      mat-mini-fab
      color='primary'
      type='submit'
      class="mt-2 d-inline ml-2">
      <mat-icon>search</mat-icon>
    </button>
  </div>

</form>

<app-code-scanner></app-code-scanner>

<mat-spinner *ngIf='isLoading'></mat-spinner>

<mat-accordion multi='true' *ngIf='trackings.length > 0 && !isLoading'>
  <mat-expansion-panel *ngFor='let tracking of trackings'>

    <mat-expansion-panel-header class={{getHeaderColor(tracking.status)}}>
      <mat-panel-title class="text-white">
        <div>{{ tracking.trackingNumber }} {{tracking.carrier}} {{tracking.status}}</div>
        <div class="ml-auto">{{formatDateTime(tracking.updatedAt)}}</div>
      </mat-panel-title>
    </mat-expansion-panel-header>
    <div>
      <ng-template matExpansionPanelContent>
        <div class='tracking-image mt-3' *ngIf="tracking.imagePath">
          <img [src]='tracking.imagePath' (click)="openDialog(tracking.imagePath)">
        </div>
        <hr>
        <div class="row">
          <div class="col-md-6">
            <div class="mat-title">Note</div>
            <div class="scroll-box">
              <p>{{ tracking.content }}</p>
            </div>
          </div>
          <div class="col-md-6 mt-xs-2 mt-md-0">

            <!-- <div class="mat-title mt-3 mt-md-0">Comment</div> -->
            <ng-container *ngIf="userIsAuthenticated">
              <form [formGroup]='commentForm' (submit)='onCommentSubmit(tracking._id)' (keydown.meta.Enter)="onCommentSubmit(tracking._id)">
                <div class="d-flex">
                  <mat-form-field appearance="outline" class="mr-2">
                    <mat-label>Comment</mat-label>
                    <textarea
                      matInput
                      formControlName='commentContent'
                      cdkTextareaAutosize>
                    </textarea>
                  </mat-form-field>
                  <button
                    mat-icon-button
                    color='primary'
                    type='submit'
                    class="mt-2 d-inline">
                    <mat-icon>send</mat-icon>
                  </button>
                </div>
              </form>
            </ng-container>

            <div class="scroll-box">
              <ng-container *ngFor="let comment of tracking.comments">
                <div class="mat-body-strong">{{comment?.name}}</div>
                <div>{{formatDateTime(comment?.updatedAt)}}</div>
                <div>{{comment?.content}}</div>
                <hr>
              </ng-container>
            </div>
          </div>
        </div>
      </ng-template>
    </div>


    <mat-action-row *ngIf="userIsAuthenticated && userId === tracking.creatorId">
      <div>
        <a mat-button color='primary' [routerLink]="['/edit', tracking._id]" >Edit</a>
        <button mat-button color='warn' (click)='onDelete(tracking._id)'>Delete</button>
      </div>

      <!-- <div *ngIf="userIsAuthenticated && userId !== tracking.creatorId">
        <div *ngIf="!subscribedTrackings.includes(tracking._id); else subscribed">
          <button mat-raised-button color='primary' (click)='onSubscribe(tracking._id)'>Subscribe</button>
        </div>

        <ng-template #subscribed>
          <button mat-raised-button color='warn' (click)='onUnSubscribe(tracking._id)'>Unsubscribe</button>
        </ng-template>
      </div> -->

    </mat-action-row>
  </mat-expansion-panel>
</mat-accordion>

<mat-paginator [length]='totalTrackings' [pageSize]='trackingsPerPage' [pageSizeOptions]='pageSizeOptions' (page)='onChangedPage($event)'></mat-paginator>
<p class='info-text mat-body-1' *ngIf='trackings.length <= 0 && !isLoading'>No trackings added yet</p>
